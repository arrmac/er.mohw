/*! grafana - v1.7.0 - 2014-08-16
 * Copyright (c) 2014 Torkel Ã–degaard; Licensed Apache License */

define(["angular","lodash","moment","config","filesaver"],function(a,b,c,d){var e=a.module("grafana.controllers");e.controller("dashLoader",["$scope","$rootScope","$http","alertSrv","$location","playlistSrv","datasourceSrv",function(b,e,f,g,h,i,j){b.init=function(){b.db=j.getGrafanaDB(),b.onAppEvent("save-dashboard",function(){b.saveDashboard()}),b.onAppEvent("zoom-out",function(){b.zoom(2)})},b.set_default=function(){window.localStorage.grafanaDashboardDefault=h.path(),g.set("Home Set","This page has been set as your default dashboard","success",5e3)},b.purge_default=function(){delete window.localStorage.grafanaDashboardDefault,g.set("Local Default Clear","Your default dashboard has been reset to the default","success",5e3)},b.saveForSharing=function(){var c=a.copy(b.dashboard);c.temp=!0,b.db.saveDashboard(c).then(function(a){b.share={url:a.url,title:a.title}},function(a){g.set("Save for sharing failed",a,"error",5e3)})},b.passwordCache=function(a){return window.sessionStorage?a?void(window.sessionStorage.grafanaAdminPassword=a):window.sessionStorage.grafanaAdminPassword:null},b.isAdmin=function(){if(!d.admin||!d.admin.password)return!0;if(this.passwordCache()===d.admin.password)return!0;var a=window.prompt("Admin password","");return this.passwordCache(a),a===d.admin.password?!0:(g.set("Save failed","Password incorrect","error"),!1)},b.saveDashboard=function(){if(!this.isAdmin())return!1;var c=a.copy(b.dashboard);b.db.saveDashboard(c).then(function(a){g.set("Dashboard Saved",'Dashboard has been saved as "'+a.title+'"',"success",5e3),h.search({}),h.path(a.url),e.$emit("dashboard-saved",b.dashboard)},function(a){g.set("Save failed",a,"error",5e3)})},b.deleteDashboard=function(a){return confirm("Are you sure you want to delete dashboard?")?this.isAdmin()?void b.db.deleteDashboard(a).then(function(a){g.set("Dashboard Deleted",a+" has been deleted","success",5e3)},function(){g.set("Dashboard Not Deleted","An error occurred deleting the dashboard","error",5e3)}):!1:void 0},b.exportDashboard=function(){var c=new Blob([a.toJson(b.dashboard,!0)],{type:"application/json;charset=utf-8"});window.saveAs(c,b.dashboard.title+"-"+(new Date).getTime())},b.zoom=function(a){var d=b.filter.timeRange(),e=d.to.valueOf()-d.from.valueOf(),f=d.to.valueOf()-e/2,g=f+e*a/2,h=f-e*a/2;if(g>Date.now()&&d.to<Date.now()){var i=g-Date.now();h-=i,g=Date.now()}b.filter.setTime({from:c.utc(h).toDate(),to:c.utc(g).toDate()})},b.styleUpdated=function(){b.grafana.style=b.dashboard.style},b.openSaveDropdown=function(){b.isFavorite=i.isCurrentFavorite(b.dashboard),b.saveDropdownOpened=!0},b.markAsFavorite=function(){i.markAsFavorite(b.dashboard),b.isFavorite=!0},b.removeAsFavorite=function(){i.removeAsFavorite(b.dashboard),b.isFavorite=!1},b.stopPlaylist=function(){i.stop(1)}}])});