/*! grafana - v1.7.0 - 2014-08-28
 * Copyright (c) 2014 Torkel Ã–degaard; Licensed Apache License */

define(["angular","lodash","config","../services/graphite/gfunc","../services/graphite/parser"],function(a,b,c,d,e){var f=a.module("grafana.controllers");f.controller("GraphiteTargetCtrl",["$scope","$sce",function(c,f){function g(){c.functions=[],c.segments=[],c.showTextEditor=!1,delete c.parserError;var a=new e(c.target.target),b=a.getAst();if(null===b)return void j(0);if("error"===b.type)return c.parserError=b.message+" at position: "+b.pos,void(c.showTextEditor=!0);try{h(b)}catch(d){console.log("error parsing target:",d.message),c.parserError=d.message,c.showTextEditor=!0}j(c.segments.length-1)}function h(a,e,f){if(null===a)return null;switch(a.type){case"function":var g=d.createFuncInstance(a.name);b.each(a.params,function(a,b){h(a,g,b)}),g.updateText(),c.functions.push(g);break;case"string":case"number":if(f-1>=e.def.params.length)throw{message:"invalid number of parameters to method "+e.def.name};0===f?e.params[f]=a.value:e.params[f-1]=a.value;break;case"metric":if(c.segments.length>0)throw{message:"Multiple metric params not supported, use text editor."};c.segments=b.map(a.segments,function(a){return new m(a)})}}function i(a){var d=c.segments.slice(0,a);return b.reduce(d,function(a,b){return a?a+"."+b.value:b.value},"")}function j(a){if(0===a)return void c.segments.push(new m("select metric"));var b=i(a+1);return c.datasource.metricFindQuery(c.filter,b).then(function(b){if(0===b.length)return c.segments=c.segments.splice(0,a),void c.segments.push(new m("select metric"));if(b[0].expandable){if(c.segments.length!==a)return j(a+1);c.segments.push(new m("select metric"))}}).then(null,function(a){c.parserError=a.message||"Failed to issue metric query"})}function k(a){b.each(c.segments,function(b,c){b.focus=a===c})}function l(a,b){return b.render(a)}function m(a){return"*"===a||"*"===a.value?(this.value="*",this.html=f.trustAsHtml('<i class="icon-asterisk"><i>'),void(this.expandable=!0)):b.isString(a)?(this.value=a,void(this.html=f.trustAsHtml(this.value))):(this.value=a.value,this.type=a.type,this.expandable=a.expandable,void(this.html=f.trustAsHtml("template"===a.type?a.value:this.value)))}c.init=function(){c.target.target=c.target.target||"",g()},c.getAltSegments=function(a){c.altSegments=[];var d=0===a?"*":i(a)+".*";return c.datasource.metricFindQuery(c.filter,d).then(function(a){c.altSegments=b.map(a,function(a){return new m({value:a.text,expandable:a.expandable})}),b.each(c.filter.templateParameters,function(a){c.altSegments.unshift(new m({type:"template",value:"[["+a.name+"]]",expandable:!0}))}),c.altSegments.unshift(new m("*"))}).then(null,function(a){c.parserError=a.message||"Failed to issue metric query"})},c.setSegment=function(a,b){return delete c.parserError,c.segments[b].value=c.altSegments[a].value,c.segments[b].html=c.altSegments[a].html,c.functions.length>0&&c.functions[0].def.fake&&(c.functions=[]),c.altSegments[a].expandable?j(b+1).then(function(){k(b+1),c.targetChanged()}):(c.segments=c.segments.splice(0,b+1),k(b+1),void c.targetChanged())},c.targetTextChanged=function(){g(),c.$parent.get_data()},c.targetChanged=function(){if(!c.parserError){var a=c.target.target,d=i(c.segments.length);c.target.target=b.reduce(c.functions,l,d),c.target.target!==a&&c.$parent.get_data()}},c.removeFunction=function(a){c.functions=b.without(c.functions,a),c.targetChanged()},c.addFunction=function(a){var b=d.createFuncInstance(a);b.added=!0,c.functions.push(b),c.moveAliasFuncLast(),c.smartlyHandleNewAliasByNode(b),!b.params.length&&b.added&&c.targetChanged()},c.moveAliasFuncLast=function(){var a=b.find(c.functions,function(a){return"alias"===a.def.name||"aliasByNode"===a.def.name||"aliasByMetric"===a.def.name});a&&(c.functions=b.without(c.functions,a),c.functions.push(a))},c.smartlyHandleNewAliasByNode=function(a){if("aliasByNode"===a.def.name)for(var b=0;b<c.segments.length;b++)if(c.segments[b].value.indexOf("*")>=0)return a.params[0]=b,a.added=!1,void c.targetChanged()},c.toggleMetricOptions=function(){c.panel.metricOptionsEnabled=!c.panel.metricOptionsEnabled,c.panel.metricOptionsEnabled||delete c.panel.cacheTimeout},c.duplicate=function(){var b=a.copy(c.target);c.panel.targets.push(b)}}]),f.directive("focusMe",["$timeout","$parse",function(a,b){return{link:function(c,d,e){var f=b(e.focusMe);c.$watch(f,function(b){b===!0&&a(function(){d[0].focus()})})}}}])});