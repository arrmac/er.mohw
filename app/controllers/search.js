/*! grafana - v1.7.0 - 2014-08-16
 * Copyright (c) 2014 Torkel Ã–degaard; Licensed Apache License */

define(["angular","lodash","config","jquery"],function(a,b,c,d){var e=a.module("grafana.controllers");e.controller("SearchCtrl",["$scope","$rootScope","$element","$location","datasourceSrv",function(a,b,c,e,f){a.init=function(){a.giveSearchFocus=0,a.selectedIndex=-1,a.results={dashboards:[],tags:[],metrics:[]},a.query={query:"title:"},a.db=f.getGrafanaDB(),a.onAppEvent("open-search",a.openSearch)},a.keyDown=function(b){if(27===b.keyCode&&c.find(".dropdown-toggle").dropdown("toggle"),40===b.keyCode&&a.selectedIndex++,38===b.keyCode&&a.selectedIndex--,13===b.keyCode){if(a.tagsOnly){var f=a.results.tags[a.selectedIndex];return void(f&&a.filterByTag(f.term))}var g=a.results.dashboards[a.selectedIndex];g&&(e.search({}),e.path("/dashboard/db/"+g.id),setTimeout(function(){d("body").click()}))}},a.shareDashboard=function(b,c){var d=window.location.href.replace(window.location.hash,"");a.share={title:b,url:d+"#dashboard/db/"+encodeURIComponent(c)}},a.searchDashboards=function(b){return a.db.searchDashboards(b).then(function(b){a.tagsOnly=b.tagsOnly,a.results.dashboards=b.dashboards,a.results.tags=b.tags})},a.filterByTag=function(b,c){a.query.query="tags:"+b+" AND title:",a.search(),a.giveSearchFocus=a.giveSearchFocus+1,c&&(c.stopPropagation(),c.preventDefault())},a.showTags=function(b){b.stopPropagation(),a.tagsOnly=!a.tagsOnly,a.query.query=a.tagsOnly?"tags!:":"",a.giveSearchFocus=a.giveSearchFocus+1,a.selectedIndex=-1,a.search()},a.search=function(){a.showImport=!1,a.selectedIndex=-1,a.searchDashboards(a.query.query)},a.openSearch=function(b){b&&c.next().find(".dropdown-toggle").dropdown("toggle"),a.searchOpened=!0,a.giveSearchFocus=a.giveSearchFocus+1,a.query.query="title:",a.search()},a.addMetricToCurrentDashboard=function(b){a.dashboard.rows.push({title:"",height:"250px",editable:!0,panels:[{type:"graphite",title:"test",span:12,targets:[{target:b}]}]})},a.toggleImport=function(b){b.stopPropagation(),a.showImport=!a.showImport},a.newDashboard=function(){e.url("/dashboard/file/empty.json")}}]),e.directive("xngFocus",function(){return function(a,b,c){d(b).click(function(a){a.stopPropagation()}),a.$watch(c.xngFocus,function(a){setTimeout(function(){a&&b.focus()},200)},!0)}})});